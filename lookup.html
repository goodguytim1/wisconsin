<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generate Advocacy Kit</title>
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* Reset & base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ece9e6, #ffffff);
      color: #333;
    }
    
    /* Header styling */
    header {
      text-align: center;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    header img {
      height: 50px;
    }

    /* Container wrapping the form */
    .container {
      max-width: 650px;
      margin: 60px auto;
      background: #fff;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    /* Header text */
    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    /* Intro paragraph styling */
    p.intro-text {
      text-align: center;
      font-size: 1.1em;
      color: #555;
      margin-bottom: 30px;
      line-height: 1.4;
    }

    /* The form */
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Label styling */
    label {
      font-weight: 600;
      margin-bottom: 5px;
      display: inline-block;
      transition: color 0.3s ease;
    }

    /* Error label styling */
    .label-error {
      color: #d9534f; /* red color for error labels */
    }

    /* Inputs, selects, textareas */
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      transition: border-color 0.3s ease;
      font-size: 0.95rem;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      border-color: #007bff;
      outline: none;
    }

    /* Error highlighting on inputs */
    .input-error {
      border-color: #d9534f !important;
    }

    /* Inline error messages */
    .inline-error {
      background-color: #ffecec;
      border: 1px solid #d9534f;
      color: #d9534f;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Legal disclaimer container */
    .legal-container {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f9f9f9;
      margin-top: 15px;
    }
    .legal-container input[type="checkbox"] {
      margin-top: 3px;
      flex-shrink: 0;
    }
    .legal-container label {
      font-weight: normal;
      cursor: pointer;
      line-height: 1.4;
    }

    /* Submit button */
    button[type="submit"] {
      align-self: center;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 12px 20px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button[type="submit"]:hover {
      background: #0056b3;
    }

    /* Footer styling */
    .footer {
      text-align: center;
      margin-top: 40px;
      color: #888;
      padding: 20px;
      background: #fff;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    .footer img {
      height: 40px;
      margin-bottom: 10px;
    }
    .footer p {
      margin-bottom: 6px;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .container {
        margin: 20px auto;
        padding: 20px;
      }
      button[type="submit"] {
        width: 100%;
      }
    }

    /* Loading overlay styles */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none; /* Hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #007bff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Website Header with Logo -->
  <header>
    <a href="index.html">
      <img src="StopTaxationLogo.png" alt="Stop Taxation Logo">
    </a>
  </header>

  <div class="container">
    <h2>Create Your Wisconsin Advocacy Kit</h2>
    <p class="intro-text">
      Please fill in your details. We'll use your <strong>Wisconsin Street Address</strong> to look up your
      representatives, and the rest of the fields will personalize your letters/emails.
    </p>

    <!-- Form with custom onsubmit handler -->
    <form onsubmit="handleFormSubmission(event)">
      <!-- PERSONAL ADDRESS -->
      <div>
        <label for="address" id="addressLabel">Wisconsin Street Address</label>
        <input
          type="text"
          id="address"
          name="address"
          placeholder="123 Park St, Wausau, WI 54401"
          required
        />
        <!-- Inline error message -->
        <div id="addressError" class="inline-error" style="display: none;"></div>
      </div>

      <!-- NAME -->
      <div>
        <label for="name">Your Full Name</label>
        <input
          type="text"
          id="name"
          name="agentInfo[name]"
          placeholder="Jane Doe"
          required
        />
      </div>

      <!-- BUSINESS TITLE -->
      <div>
        <label for="businessTitle">Business Title</label>
        <input
          type="text"
          id="businessTitle"
          name="agentInfo[businessTitle]"
          placeholder="Owner / Agent"
          required
        />
      </div>

      <!-- BUSINESS NAME -->
      <div>
        <label for="businessName">Business Name</label>
        <input
          type="text"
          id="businessName"
          name="agentInfo[businessName]"
          placeholder="My Travel Company"
        />
      </div>

      <!-- BUSINESS MAILING ADDRESS -->
      <div>
        <label for="mailingAddress" id="mailingAddressLabel">Business Mailing Address</label>
        <input
          type="text"
          id="mailingAddress"
          name="agentInfo[mailingAddress]"
          placeholder="123 Main St, City, ST 12345"
          required
        />
        <!-- CHECKBOX FOR SAME ADDRESS -->
        <div style="margin-top: 8px;">
          <input
            type="checkbox"
            id="sameAddressCheckbox"
            name="sameAddressCheckbox"
            onclick="toggleSameAddress()"
          />
          <label for="sameAddressCheckbox">Same as Personal Address</label>
        </div>
        <!-- Inline error message -->
        <div id="mailingAddressError" class="inline-error" style="display: none;"></div>
      </div>

      <!-- EMAIL -->
      <div>
        <label for="email">Email</label>
        <input
          type="text"
          id="email"
          name="agentInfo[email]"
          placeholder="you@example.com"
          required
        />
      </div>

      <!-- PHONE -->
      <div>
        <label for="phone">Phone</label>
        <input
          type="text"
          id="phone"
          name="agentInfo[phone]"
          placeholder="(555) 123-4567"
          required
        />
      </div>

      <!-- YEARS IN BUSINESS -->
      <div>
        <label for="yearsInBusiness">Years in Business</label>
        <input
          type="number"
          id="yearsInBusiness"
          name="agentInfo[yearsInBusiness]"
          min="0"
          max="99"
          value="5"
          required
        />
      </div>

      <!-- HOST AGENCY -->
      <div>
        <label for="yourHostAgency">Host Agency</label>
        <select id="yourHostAgency" name="agentInfo[hostAgency]" required>
          <option value="">-- Select --</option>
          <option value="Outside Agents">Outside Agents</option>
          <option value="KHM Travel">KHM Travel</option>
          <option value="Nexion">Nexion</option>
          <option value="Other">Other</option>
          <option value="Independent">No Host - Independent</option>
        </select>
      </div>

      <!-- PERSONAL STORY -->
      <div>
        <label for="personalStory">Personal Impact Statement</label>
        <textarea
          id="personalStory"
          name="agentInfo[personalStory]"
          rows="4"
          placeholder="(Optional)"
        ></textarea>
      </div>

      <p class="intro-text" style="color: red; margin-top: 0;">
        Only for use by Wisconsin based travel agents!
      </p>

      <!-- LEGAL DISCLAIMER CHECKBOX (User-friendly layout) -->
      <div class="legal-container">
        <input
          type="checkbox"
          id="legalDisclaimer"
          name="legalDisclaimer"
          required
        />
        <label for="legalDisclaimer">
          Your information will not be sold or shared commercially. It will only be used to validate the number and location of supporters, contact you with important updates, and you can unsubscribe at any time.
        </label>
      </div>

      <!-- SUBMIT BUTTON -->
      <button type="submit">Generate My Advocacy Kit</button>
    </form>
  </div>

  <!-- Loading overlay with spinner -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Regex for capturing groups: street, city, state, zip
    const addressRegex =
      /^(?<street>[^,]+),\s*(?<city>[^,]+),\s*(?<state>[A-Za-z]{2})\s+(?<zip>\d{5})$/;

    // Toggle checkbox for same address
    function toggleSameAddress() {
      const personalAddress = document.getElementById('address');
      const businessAddress = document.getElementById('mailingAddress');
      const sameAddressCheck = document.getElementById('sameAddressCheckbox');

      if (sameAddressCheck.checked) {
        // Copy current personal address
        businessAddress.value = personalAddress.value;
        // Disable the field so the user can't type into it
        businessAddress.disabled = true;
        // Sync changes from personal address to business address
        personalAddress.addEventListener('input', syncAddresses);
      } else {
        personalAddress.removeEventListener('input', syncAddresses);
        businessAddress.value = '';
        businessAddress.disabled = false;
      }
    }

    // Sync personal address to business address when using same address option
    function syncAddresses() {
      const personalAddress = document.getElementById('address');
      const businessAddress = document.getElementById('mailingAddress');
      businessAddress.value = personalAddress.value;
    }

    /*
      showError(field, label, errorField, errorMessage):
        - Adds error styling to the field and label,
        - Displays the inline error message,
        - Scrolls the error into view.
    */
    function showError(field, label, errorField, errorMessage) {
      field.classList.add('input-error');
      label.classList.add('label-error');
      if (!label.innerText.endsWith('*')) {
        label.innerText += ' *';
      }
      errorField.style.display = 'block';
      errorField.innerText = errorMessage;
    }

    // Clear error styling/messages
    function clearError(field, label, errorField, originalLabelText) {
      field.classList.remove('input-error');
      label.classList.remove('label-error');
      label.innerText = originalLabelText;
      errorField.style.display = 'none';
      errorField.innerText = '';
    }

    /*
      validateAddress(field, labelElem, errorElem, labelText):
        Validates the address format.
    */
    function validateAddress(field, labelElem, errorElem, labelText) {
      const value = field.value.trim();
      const match = value.match(addressRegex);
      const subErrors = [];

      if (!match) {
        subErrors.push("Ensure the address includes street, city, state (WI), and ZIP code.");
        if ((value.match(/,/g) || []).length < 2) {
          subErrors.push("Address must have commas separating street, city, and state.");
        }
        if (!/\d{5}$/.test(value)) {
          subErrors.push("A 5-digit ZIP code is required.");
        }
      } else {
        const { street, city, state, zip } = match.groups;
        if (!street) subErrors.push("Street is missing.");
        if (!city) subErrors.push("City is missing.");
        if (!state) subErrors.push("State code (e.g., WI) is missing.");
        if (!zip) subErrors.push("ZIP code (5 digits) is missing.");
        if (state !== "WI") subErrors.push("The state must be Wisconsin (WI) to participate.");
      }

      if (subErrors.length > 0) {
        return `Issues with ${labelText}:\n- ${subErrors.join("\n- ")}`;
      }
      return "";
    }

    // Main validation function
    function validateForm() {
      const personalAddressField = document.getElementById('address');
      const personalAddressLabel = document.getElementById('addressLabel');
      const personalAddressError = document.getElementById('addressError');
      const personalLabelText = "Wisconsin Street Address";

      const businessAddressField = document.getElementById('mailingAddress');
      const businessAddressLabel = document.getElementById('mailingAddressLabel');
      const businessAddressError = document.getElementById('mailingAddressError');
      const businessLabelText = "Business Mailing Address";

      clearError(personalAddressField, personalAddressLabel, personalAddressError, personalLabelText);
      clearError(businessAddressField, businessAddressLabel, businessAddressError, businessLabelText);

      let personalErrorMsg = validateAddress(personalAddressField, personalAddressLabel, personalAddressError, personalLabelText);
      let businessErrorMsg = "";
      if (businessAddressField.disabled) {
        businessErrorMsg = personalErrorMsg
          ? "Because your business address is the same as your personal address, you must fix that address first."
          : "";
      } else {
        businessErrorMsg = validateAddress(businessAddressField, businessAddressLabel, businessAddressError, businessLabelText);
      }

      const firstErrorField = personalErrorMsg ? personalAddressField : businessErrorMsg ? businessAddressField : null;

      if (personalErrorMsg) {
        showError(personalAddressField, personalAddressLabel, personalAddressError, personalErrorMsg);
      }
      if (businessErrorMsg) {
        showError(businessAddressField, businessAddressLabel, businessAddressError, businessErrorMsg);
      }

      // Check if the legal disclaimer checkbox is checked
      const legalCheckbox = document.getElementById('legalDisclaimer');
      if (!legalCheckbox.checked) {
        legalCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        alert('Please agree to the legal disclaimer.');
        legalCheckbox.focus();
        return false;
      }

      if (firstErrorField) {
        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstErrorField.focus();
        return false;
      }
      return true;
    }

    // Handle form submission with loading overlay and async/await
    async function handleFormSubmission(event) {
      event.preventDefault();
      if (!validateForm()) {
        return false;
      }
      
      // Show the loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.display = 'flex';

      const data = {
        address: document.getElementById('address').value.trim(),
        agentInfo: {
          name: document.getElementById('name').value.trim(),
          businessTitle: document.getElementById('businessTitle').value.trim(),
          businessName: document.getElementById('businessName').value.trim(),
          mailingAddress: document.getElementById('mailingAddress').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          yearsInBusiness: document.getElementById('yearsInBusiness').value.trim(),
          hostAgency: document.getElementById('yourHostAgency').value.trim(),
          personalStory: document.getElementById('personalStory').value.trim()
        },
        legalDisclaimer: document.getElementById('legalDisclaimer').checked
      };

      try {
        const response = await fetch('https://streaming1-a0f6be3ac16e.herokuapp.com/createAdvocacyKit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Request failed');
        }
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'advocacy_package.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        loadingOverlay.style.display = 'none';
        window.location.href = '/confirmation.html';
      } catch (error) {
        loadingOverlay.style.display = 'none';
        alert('An error occurred: ' + error.message);
        console.error('Error:', error);
        return false;
      }
    }
  </script>
</body>
</html>
